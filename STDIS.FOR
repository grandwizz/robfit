C$NOEXT
C$NOWAR
        PROGRAM STDIS
      PARAMETER (MAXCHN=1024)
         REAL*8 CHIS
         COMMON/AXISP/BHORI,BVERT,SF,SVERT,EHORI,EVERT
        INTEGER*2 IMULT,IXDIV,IX,IFA,IFB,ICH,NRES,IDAT,IFMA
        DIMENSION NRES(MAXCHN),IDAT(MAXCHN),IFA(MAXCHN),IX(MAXCHN),
     # ICH(MAXCHN,6),IFB(MAXCHN),RANS(5)
        DIMENSION FORIG(4),XORIG(4),FINT(4),XINT(4)
        CHARACTER*8 II
        CHARACTER*64 NA,CTEMP,NAMENU,LABEL,STATUS
        CHARACTER*1 ANS,CANS(140)
        EQUIVALENCE (CTEMP,CANS(1))
C*************************************************
C
C   GRASHAPE DATA
C
C*************************************************
      CHARACTER*64 GDNAME
      CHARACTER*1 VCF,VSP,VBG
      COMMON/CHGRAS/GDNAME,VCF,VSP,VBG
      COMMON/CGRASH/ABEGC,AENDC,IIMIN,IIMAX,LFLAG
      COMMON/BATCFL/IBATCH
C*************************************************
        IMFLAG=0
        IBATCH=0
        LABEL='Channel Number\'
        NAMENU='STDIS.MNU'
5       CONTINUE
        IF(IMFLAG.EQ.0) CALL GSLINK(NAMENU)
        IF(NAMENU.EQ.'STOP')THEN
          STOP
C M       RETURN
        ENDIF
        STATUS='OLD'
        CALL MAOPEN(3,GDNAME,STATUS)
        READ(3,'(2Z4,A8,E20.12)',ERR=998)IMULT,IXDIV,II,CHIS
         CHI=CHIS
        AXDIV=IXDIV
        DO 300 I=1,1024
        READ(3,'(11Z4)',END=302,ERR=998)NRES(I),IDAT(I),IFA(I),IFB(I),
     # IX(I),(ICH(I,J),J=1,6)
300     CONTINUE
302     IMC=I-1
        CLOSE (3)
        AMULT=.001*IMULT
320     CONTINUE
        IF(IMFLAG.EQ.1)THEN
        WRITE(*,103)1.*IX(1)/AXDIV,1.*IX(IMC)/AXDIV
103     FORMAT(' DATA HAS ABSICCA FROM',F8.2,' TO',F8.2 /
     # ' INITIAL X?, END X?',' <-1,0> FOR MENU <0,0> DEFAULT')
        CALL CHREAD(9,80,RANS,CANS,2,0,IEND)
        ABEGC=RANS(1)
        AENDC=RANS(2)
          IF(ABEGC.EQ.-1)THEN
            IMFLAG=0
            GOTO 5
          ENDIF
        ENDIF
330     IF(AENDC.EQ.0.)ABEGC=1.*IX(1)/AXDIV
        IF(AENDC.EQ.0.)AENDC=1.*IX(IMC)/AXDIV
        IF(ABEGC.GE.AENDC)WRITE(*,104)
104     FORMAT(' THERE ARE NO CHANNELS IN THE INTERVAL',F10.0,',',F10.0)
        IF(ABEGC.GE.AENDC)GOTO 320
        SF=700./(AENDC-ABEGC)
        AMIN=2000000000
        AMAX=0
        DO 340 I=1,IMC
        XP=IX(I)/IXDIV
        IF(XP.LT.ABEGC.OR.XP.GT.AENDC)GOTO 340
        AMIN=AMIN1(AMIN,EXP(AMULT*IDAT(I)))
        AMAX=AMAX1(AMAX,EXP(AMULT*IDAT(I)))
340     CONTINUE
        AMIN=AMAX1(1.,AMIN)
        IMIN=AMIN
        IXR=ALOG10(AMIN+1)-1
        IXRDIV=10**IXR
        IXRDIV=MAX0(IXRDIV,1)
        IMIN=IXRDIV*(IMIN/IXRDIV)
        AMIN=IMIN
        IF(IMFLAG.EQ.1)THEN
          WRITE(*,108)AMIN,AMAX
108     FORMAT(' AMIN=',F8.0,'  AMAX=',F8.0/' ENTER DESIRED MIN',
     # ',DESIRED MAX')
        CALL CHREAD(9,80,RANS,CANS,2,0,IEND)
        IMIN=RANS(1)+.5
        IMAX=RANS(2)+.5
        ELSE
          IMIN=IIMIN
          IMAX=IIMAX
        ENDIF
        IF(IMIN.EQ.0.AND.IMAX.EQ.0)GOTO 314
        AMIN=IMIN
        AMAX=IMAX
314     CONTINUE
        IF(IMFLAG.EQ.1)THEN
          WRITE(*,120)
120       FORMAT(' DO YOU WANT A LOG SCALE?')
          LFLAG=0
115       FORMAT(A1)
          READ(*,115)ANS
          IF(ANS.NE.'Y'.OR.ANS.EQ.'y')GOTO 400
          LFLAG=1
        ENDIF
        IF(LFLAG.NE.1)GOTO 400
        AMIN=AMAX1(1.E-4,AMIN)
        AMAX=ALOG(AMAX)
        AMIN=ALOG(AMIN)
400     IRES=1
        IF(IBATCH.NE.4)CALL STPL(-1.,-1.)
        CALL AXIS(AMIN,AMAX,LFLAG,IRES,ABEGC,AENDC,II,CHI,LABEL)
         HRES=EVERT-.1021
        CHISL=0
        IMOVE=0
        DO 500 I=1,IMC
         XTEST=IX(I)/AXDIV
         IF(XTEST.LT.ABEGC.OR.XTEST.GT.AENDC)GOTO 500
        XP=BHORI+SF*(XTEST-ABEGC)
        IF(I.LT.IMC)TSF=SF*(IX(I+1)-IX(I))/(2*AXDIV)
        CHISL=CHISL+(NRES(I)/100.)**2
        ADAT=EXP(AMULT*IDAT(I))
        IF(LFLAG.EQ.1)ADAT=AMAX1(AMIN,ALOG(AMAX1(1.E-4,ADAT)))
        YDAT=SVERT*(ADAT-AMIN)+BVERT
C *** THE FIRST PLOT CALL
        IF(IMOVE.EQ.0)CALL STPL(AMAX1(BHORI,XP-TSF),YDAT)
        IF(IMOVE.NE.0)CALL PLOT(AMAX1(BHORI,XO),YDAT)
        IMOVE=1
        XO=XP+TSF
        CALL PLOT(XO,YDAT)
500     CONTINUE
        CALL NUMOUT(0.1,0.,CHISL,0)
        CTEMP=' CHISL=\'
        CALL BCHART(0.,0.,CTEMP)
505     CONTINUE
        ANS=VCF
        IF(ANS.NE.'Y'.AND.ANS.NE.'y')GOTO 650
        CALL LINET('SDAS')
        IMOVE=0
        DO 600 I=1,IMC
         XTEST=IX(I)/AXDIV
         IF(XTEST.LT.ABEGC.OR.XTEST.GT.AENDC)GOTO 600
         XP=BHORI+SF*(XTEST-ABEGC)
        AFRA=EXP(AMULT*IFA(I))
        IF(LFLAG.EQ.1)AFRA=AMAX1(AMIN,ALOG(AMAX1(1.E-4,AFRA)))
        YY=SVERT*(AFRA-AMIN)+BVERT
        IF(IMOVE.EQ.0)CALL STPL(XP-TSF,YY)
        IMOVE=1
        CALL PLOT(XP,YY)
        IF(I.LT.2)GOTO 600
        IF(I.GT.IMC-3)GOTO 600
        SFE=SF*.25*(IX(I+1)-IX(I))/AXDIV
        IF(SFE.LT.1.)GOTO 600

C *** INTERPOLATION SECTION
580     IB=MAX0(4+I-IMC,2)
        IF(I.EQ.1)IB=1
        IF(IB.EQ.4)GOTO 600
        IEX=4
        DO 582 K=1,4
        FORIG(K)=EXP(AMULT*IFA(I-IB+K))
        IF(LFLAG.EQ.1)FORIG(K)=AMAX1(AMIN,ALOG(AMAX1(1.E-4,FORIG(K))))
582     XORIG(K)=IX(I-IB+K)/AXDIV
        CALL PLINTERP(FORIG,XORIG,FINT,XINT,IB,IEX)
        DO 583 K=1,IEX
        FINT(K)=AMAX1(AMIN,FINT(K))
        XP=BHORI+SF*(XINT(K)-ABEGC)
        YY=SVERT*(FINT(K)-AMIN)+BVERT
583     CALL PLOT(XP,YY)
C *** END OF INTERPOLATION SECTION

600     CONTINUE
650     CONTINUE
        ANS=VSP
        IF(ANS.NE.'Y'.AND.ANS.NE.'y')GOTO 780
        CALL LINET('DOT ')
        DO 750 J=1,6
        IFPC=0
        ITEST=1
        DO 750 I=1,IMC
         XTEST=IX(I)/AXDIV
         IF(XTEST.LT.ABEGC.OR.XTEST.GT.AENDC)GOTO 750
         XP=BHORI+SF*(XTEST-ABEGC)
        APK=EXP(AMULT*ICH(I,J))
        IF(LFLAG.EQ.1)APK=AMAX1(AMIN,ALOG(AMAX1(1.E-4,APK)))
        IF(APK.LT.AMIN.OR.ITEST.EQ.1)IFPC=0
        IF(APK.LT.AMIN)GOTO 750
        YP=SVERT*(APK-AMIN)+BVERT
        IF(IFPC.NE.0)GOTO 740
        IFPC=1
        CALL STPL(XP,YP)
740     CALL PLOT(XP,YP)
        IF(I.LT.2)GOTO 750
        IF(I.GT.IMC-3)GOTO 750
        SFE=SF*.25*(IX(I+1)-IX(I))/AXDIV
        IF(SFE.LT.1.)GOTO 750

C *** INTERPOLATION SECTION
        IB=MAX0(4+I-IMC,2)
        IF(I.EQ.1)IB=1
        IF(IB.EQ.4)GOTO 750
        IEX=4
        DO 742 K=1,4
        FORIG(K)=EXP(AMULT*ICH(I-IB+K,J))
        IF(LFLAG.EQ.1)FORIG(K)=AMAX1(AMIN,ALOG(AMAX1(1.E-4,FORIG(K))))
742     XORIG(K)=IX(I-IB+K)/AXDIV
        CALL PLINTERP(FORIG,XORIG,FINT,XINT,IB,IEX)
        DO 743 K=1,IEX
        XP=BHORI+SF*(XINT(K)-ABEGC)
        FINT(K)=AMAX1(AMIN,FINT(K))
        YY=SVERT*(FINT(K)-AMIN)+BVERT
743     CALL PLOT(XP,YY)
C *** END OF INTERPOLATION SECTION

750     ITEST=ICH(I,J)
        CALL LINET('SOLI')
780     IF(IRES.EQ.0)GOTO 900
C *** NRES IS 100 TIMES THE RESIDUAL ACTUALLY FOUND
        DO 800 I=1,IMC
         XTEST=IX(I)/AXDIV
         IF(XTEST.LT.ABEGC.OR.XTEST.GT.AENDC)GOTO 800
         XP=BHORI+SF*(XTEST-ABEGC)
        FIX=HRES+.3125E-3*NRES(I)
        CALL PONT(XP,FIX)
800     CONTINUE
900     CONTINUE
        ANS=VBG
        IF(ANS.NE.'Y'.AND.ANS.NE.'y')GOTO 1650
        CALL LINET('DODA')
        IMOVE=0
        DO 1600 I=1,IMC
         XTEST=IX(I)/AXDIV
         IF(XTEST.LT.ABEGC.OR.XTEST.GT.AENDC)GOTO 1600
         XP=BHORI+SF*(XTEST-ABEGC)
        AFRA=EXP(AMULT*IFB(I))
        IF(LFLAG.EQ.1)AFRA=AMAX1(AMIN,ALOG(AMAX1(1.E-4,AFRA)))
        YY=SVERT*(AFRA-AMIN)+BVERT
        IF(IMOVE.EQ.0)CALL STPL(XP-TSF,YY)
        IMOVE=1
        CALL PLOT(XP,YY)
1600    CONTINUE
1650    CONTINUE
        CALL STPL(0.,0.)
C       CALL LINET('SOLI')
        IBATCH=0
        CALL CHREAD(9,80,RANS,CANS,0,20,IEND)
        IF(CANS(1).EQ.'C'.AND.CANS(2).EQ.' ')THEN
           CALL CLEARS
           STOP
        ENDIF
        IF(CANS(1).NE.' ')THEN
          IT=INDEX(CTEMP,'.')
          IF(IT.GT.0)THEN
            IF(CTEMP(IT+1:).EQ.'MNU'.OR.CTEMP(IT+1:).EQ.'mnu')THEN
              IBATCH=4
              IMFLAG=0
              NAMENU=CTEMP
              GOTO 5
            ENDIF
          ENDIF
        IF((CANS(1).EQ.'M'.OR.CANS(1).EQ.'m').AND.IT.EQ.0)THEN
          CALL STPL(-1.,1.)
          GOTO 5
        ENDIF
        IF(CANS(1).EQ.'Y'.OR.CANS(1).EQ.'y'.OR.CANS(1).EQ.'S'.
     # OR.CANS(1).EQ.'s'.OR.CANS(1).EQ.'E'.OR.CANS(1).EQ.'e'
     # )THEN
          CALL STPL(-1.,-1.)
          STOP
        ENDIF
      IP=1
      ABEGC=RNUMB(CANS,IP,20)
      AENDC=RNUMB(CANS,IP,20)
      CALL STPL(-1.,-1.)
      IMFLAG=1
      GOTO 330
      ENDIF
      CTEMP= ' ARE YOU FINISHED WITH THE CODE?'
      CALL BCHART(0.,.98,CTEMP)
        CALL CHREAD(9,80,RANS,CANS,0,20,IEND)
          IT=INDEX(CTEMP,'.')
          IF(IT.GT.0)THEN
          IF(CTEMP(IT+1:).EQ.'MNU'.OR.CTEMP(IT+1:).EQ.'mnu')THEN
            IBATCH=4
            NAMENU=CTEMP
            GOTO 5
          ENDIF
          ENDIF
        IF((CANS(1).EQ.'M'.OR.CANS(1).EQ.'m').AND.IT.EQ.0)THEN
            IMFLAG=0
            GOTO 5
        ENDIF
        IF(CANS(1).EQ.'Y'.OR.CANS(1).EQ.'Y'.OR.CANS(1).EQ.'S'.
     # OR.CANS(1).EQ.'s'.OR.CANS(1).EQ.'E'.OR.CANS(1).EQ.'e'
     # )THEN
          CALL ANSI
          STOP
        ENDIF
        IMFLAG=1
         GOTO 5
998     PRINT*,' ERROR IN READING FILE ',GDNAME
        READ(*,*)ITEST
        GOTO 5
        END
C*INCLUDE C:\ROBFIT\FORTRAN\GSLINK
C*INCLUDE C:\ROBFIT\FORTRAN\VPLOTS.FOR
C*INCLUDE C:\ROBFIT\FORTRAN\NUMOUT.FOR
C*INCLUDE C:\ROBFIT\FORTRAN\MENURD
C*INCLUDE C:\ROBFIT\FORTRAN\MAOPEN
C$INCLUDE GSLINK FORTRAN
C$INCLUDE VPLOTS FORTRAN
C$INCLUDE NUMOUT FORTRAN
C$INCLUDE MENURD FORTRAN
C$INCLUDE MAOPEN FORTRAN
