C$NOWAR
C$NOEXT
      PROGRAM RAWDD
        PARAMETER (MAXC=4096)
        DIMENSION F(MAXC,2),FR(MAXC),FP(MAXC),IHD(MAXC)
     2 ,NT(2),ACOUNTS(2)
      DIMENSION UFILE(2),CFILE(2),FBEGC2(2),FENDC2(2),IBEGC2(2),
     #IENDC2(2),RANS(3)
        EQUIVALENCE (IHD(1),F(1,2)),(FR(1),F(1,1)),(FP(1),F(1,2))
        CHARACTER*80 II(4)
      CHARACTER*64 UFILE,CFILE,XYFILE,FPNAME,FMNAME,TITLE,STATUS,CTEMP
        EQUIVALENCE (CTEMP,CANS(1))
      CHARACTER*1 CANS(140)
      COMMON/GLFILE/UFILE,CFILE,XYFILE,FPNAME,FMNAME,TITLE
      COMMON/GLINK/CORR,DIFF,DIFPLT,RAT1,RAT2,FBEGC2,FENDC2,
     #IMIN2,IMAX2,LFLAG2,
     #IBEGC2,IENDC2,
     #IBEGC1,IENDC1,
     #IMIN1,IMAX1,
     #LFLAG1
         COMMON/AXISP/BHORI,BVERT,SF,SVERT,EHORI,EVERT
      COMMON/BATCFL/IBATCH
        CHARACTER*1 ANS
         CHARACTER*64 NA,VALU,NAMENU,LABEL
C*************************************************
C
C ***  CALL TO MENU READER
C
      DATA II/4*' '/
      NAMENU='RAWDD.MNU'
320   CONTINUE
        IFLAG=1
      IBATCH=1
      CALL G4LINK(NAMENU)
      IF(NAMENU.EQ.'STOP')STOP
C M      IF(NAMENU.EQ.'STOP')RETURN
      IF(TITLE.EQ.'TESTING'.OR.TITLE.EQ.'NULL')THEN
        IT1=MAX0(5,INDEX(UFILE(1),'.'))
        IF(UFILE(2)(1:1).NE.'\')THEN
          IT2=MAX0(5,INDEX(UFILE(2),'.'))
          TITLE=UFILE(1)(IT1-4:IT1-1)//
     2    UFILE(2)(IT2-4:IT2-1)//'\'
        ELSE
          IT1B=MAX0(1,IT1-7)
          TITLE=UFILE(1)(IT1B:IT1B+7)//'\'
        ENDIF
      ENDIF
        LABEL='CHANNEL NUMBER\'
53    CONTINUE
        DO 5 J=1,2
        NA=UFILE(J)
        NT(J)=0
        IF(UFILE(J)(1:1).EQ.'\')GOTO 6
        N1=1
        N2=IENDC1
5       CALL BREAD(XE,F(1,J),II,IHD,NA,N1,N2,NT(J))
6       N=MAX0(NT(1),NT(2))
        IX=1
302     IMC=N
        AMULT=1
55      CONTINUE
        IF(IFLAG.NE.1)THEN
        WRITE(*,103)IX,IMC
103     FORMAT(' DATA HAS CHANNELS',2I5 /
     # ' INITIAL CHANNEL?, END CHANNEL?, <-1,0> FOR MENU')
      CALL CHREAD(9,80,RANS,CANS,2,0,IEND)
        IBEGC1=RANS(1)+.5
        IF(IBEGC1.EQ.1)IBEGC1=0
        IENDC1=RANS(2)+.5
       IF(RANS(1).EQ.-1)THEN
        CALL STPL(-1.,-1.)
        GOTO 320
       ENDIF
      ENDIF
C
C *** LINK IN MENU VALUES
C
      IBEGC=IBEGC1
      IENDC=IENDC1
C*************************
        IF(CORR.EQ.1.)THEN
          CALL CORREC(F,NT)
          CALL STPL(-1.,-1.)
          GOTO 320
        ENDIF
        IF(IENDC.NE.0)GOTO 330
        IBEGC=0
        IENDC=IMC
330     IENDC=MIN0(IMC,IENDC)
        IBT=MAX0(1,IBEGC)
        IF(IBEGC.GE.IENDC)WRITE(*,104)
104     FORMAT(' THERE ARE NO CHANNELS IN THE INTERVAL',F10.0,',',F10.0)
        IF(IBEGC.GE.IENDC)GOTO 320
        AMIN=2000000000
        AMAX=0
        AMULT=1
        DO 335 J=1,2
335     ACOUNTS(J)=0
        DO 341 J=1,2
        IF(NT(J).EQ.0)GOTO 341
        DO 340 I=IBT,IENDC
        IF(I.GT.NT(J))GOTO 340
        ACOUNTS(J)=ACOUNTS(J)+AMULT*F(I,J)
        AMIN=AMIN1(AMIN,AMULT*F(I,J))
        AMAX=AMAX1(AMAX,AMULT*F(I,J))
340     CONTINUE
341     CONTINUE
        AMIN=AMAX1(0.,AMIN)
        IF(IFLAG.NE.1)THEN
        WRITE(*,108)AMIN,AMAX
108     FORMAT(' AMIN=',F10.0,'  AMAX=',F10.0,' ENTER DESIRED MIN,MAX')
        WRITE(*,181)ACOUNTS
181     FORMAT('COUNTS IN ABOVE INTERVAL ',2F10.0)
      CALL CHREAD(9,80,RANS,CANS,2,0,IEND)
        IMIN1=RANS(1)+.5
        IMAX1=RANS(2)+.5
        ENDIF
C
C *** LINK IN MENU VALUES
C
      IMIN=IMIN1
      IMAX=IMAX1
C*************************
        IF(IMAX.EQ.0)GOTO 37
        AMIN=IMIN
        AMAX=IMAX
37      CONTINUE
      IF(IFLAG.NE.1)THEN
        LFLAG=0
      WRITE(*,555)
555   FORMAT(' DO YOU WANT A LOG Y SCALE (Y/N)')
      CALL CHREAD(9,80,RANS,CANS,0,1,IEND)
        ANS=CANS(1)
      LFLAG1=0
      IF(ANS.EQ.'Y'.OR.ANS.EQ.'y')LFLAG1=1
      ENDIF
C
C *** LINK IN MENU VALUES
C
      LFLAG=LFLAG1
C*************************
        IF(LFLAG.NE.1)GOTO 400
        AMIN=AMAX1(.01,AMIN)
        AMAX=ALOG(AMAX)
        AMIN=ALOG(AMIN)
400     IRES=0
         CALL CLEARS
C *** ABOVE MAY NEED TO COME OUT
         IF(IFLAG.NE.1)THEN
           PRINT*,' DO YOU WANT TO CLEAR THE SCREEN'
           CALL CHREAD(9,80,RANS,CANS,0,1,IEND)
           IF(CANS(1).EQ.' '.OR.CANS(1).EQ.'Y'.OR.CANS(1).EQ.'y')
     2     CALL STPL(-1.,-1.)
        IF(CANS(1).EQ.'S'.
     # OR.CANS(1).EQ.'s'.OR.CANS(1).EQ.'E'.OR.CANS(1).EQ.'e'
     # )THEN
        CALL ANSI
        STOP
C M        RETURN
      ENDIF
         ENDIF
         ABEGC=1.*IBEGC
         AENDC=1.*IENDC
         CHI=0.
        CALL AXIS(AMIN,AMAX,LFLAG,IRES,ABEGC,AENDC,TITLE,CHI,LABEL)
        ISKIP=2/(1000*SF)
        ISKIP=MAX0(1,ISKIP)
         DO 505 JO=1,2
        IF(NT(JO).EQ.0)GOTO 505
        XO=BHORI
        ITEND=MIN0(IENDC,NT(JO))
        DO 500 I=IBT,ITEND,ISKIP
        XP=BHORI+SF*(I-IBEGC)
        ADAT=AMULT*F(I,JO)
        IF(LFLAG.EQ.1)ADAT=ALOG(AMAX1(1.,ADAT))
        YDAT=SVERT*(ADAT-AMIN)+BVERT
C *** THE FIRST PLOT CALL
        IF(I.EQ.IBT)CALL STPL(XO,YDAT)
        IF(ISKIP.GT.1)GOTO 495
        IF(I.GT.IBT)CALL PLOT(XO,YDAT)
        XO=XP+.5*SF
        CALL PLOT(XO,YDAT)
        GOTO 500
495     XDMAX=0
        XDMIN=1000000
        DO 497 J=1,ISKIP
        IARG=I+J-1
      IF(IARG.GT.NT(JO))GOTO 498
        COMP=F(IARG,JO)
        XDMAX=AMAX1(COMP,XDMAX)
497     XDMIN=AMIN1(XDMIN,COMP)
498     ADMIN=AMULT*XDMIN
        ADMAX=AMULT*XDMAX
        IF(LFLAG.EQ.1)ADMIN=ALOG(AMAX1(1.,ADMIN))
        IF(LFLAG.EQ.1)ADMAX=ALOG(AMAX1(1.,ADMAX))
        XDMIN=SVERT*(ADMIN-AMIN)+BVERT
        XDMAX=SVERT*(ADMAX-AMIN)+BVERT
        CALL PLOT(XO,XDMIN)
        XO=XP+.5*SF
        CALL PLOT(XO,XDMAX)
500     CONTINUE
        CALL LINET('DOT ')
505     CONTINUE
        CALL LINET('SOLI')
C
C *** LINK IN MENU DIFFERENCE DECISION
C
        IF(DIFF.NE.1.)GOTO 950
C *** NOTE THAT FR AND FP OVERWRITE THE F()'S WHICH WILL NEED TO BE REREAD
C *** IF WE WANT TO PLOT THEM AGAIN
           PRINT*,' DO YOU WANT TO CLEAR THE SCREEN'
           CALL CHREAD(9,80,RANS,CANS,0,1,IEND)
           IF(CANS(1).EQ.'C'.AND.CANS(2).EQ.' ')THEN
              CALL CLEARS
              STOP
           ENDIF
           IF(CANS(1).EQ.' '.OR.CANS(1).EQ.'Y'.OR.CANS(1).EQ.'y')
     2     CALL STPL(-1.,-1.)
        AMAX=-100000000
        AMINT=100000000
        ACOUNTS(1)=0
         RAT=RAT1/RAT2
        DO 740 I=IBT,IENDC
        FR(I)=F(I,1)-F(I,2) *RAT
         FP(I)=F(I,1)+F(I,2)*RAT*RAT
       FP(I)=AMAX1(0.,FP(I))
       IF(DIFPLT.EQ.1.)FR(I)=FR(I)/SQRT(FP(I))
        IF(I.GE.NT(1).OR.I.GE.NT(2))GOTO 740
        ACOUNTS(1)=ACOUNTS(1)+AMULT*FR(I)
        AMINT=AMIN1(AMINT,AMULT*FR(I))
740     AMAX=AMAX1(AMAX,AMULT*FR(I))
        AMIN=AMINT
C
C *** LINK IN MENU IMIN,IMAX
C
      IMIN=IMIN2
      IMAX=IMAX2
C****************************
        IF(IMAX.EQ.0)GOTO 750
        AMIN=IMIN
        AMAX=IMAX
750     CONTINUE
        LFLAG=0
C
C *** LINK IN MENU LOG FLAG
C
      LFLAG=LFLAG2
C***************************
        IF(LFLAG.NE.1)GOTO 760
        LFLAG=1
        AMIN=AMAX1(.01,AMIN)
        IF(AMAX.LE.0.)THEN
          PRINT*,' LOG DIFF THIS WAY CANNOT BE PLOTTED TRY AGAIN?'
          CALL CHREAD(9,80,RANS,CANS,0,4,IEND)
          CALL STPL(-1.,-1.)
          IF(CTEMP(:4).EQ.'STOP')THEN
            STOP
C M            RETURN
            ENDIF
          GOTO 320
        ENDIF
        AMAX=ALOG(AMAX)
        AMIN=ALOG(AMIN)
760     IRES=0
         IW4FL=0
         IF(IFLAG.NE.1)THEN
           PRINT*,' DO YOU WANT TO CLEAR THE SCREEN'
           CALL CHREAD(9,80,RANS,CANS,0,1,IEND)
        IF(CANS(1).EQ.'S'.
     # OR.CANS(1).EQ.'s'.OR.CANS(1).EQ.'E'.OR.CANS(1).EQ.'e'
     # )THEN
        CALL ANSI
        STOP
C M        RETURN
      ENDIF
           IF(CANS(1).EQ.' '.OR.CANS(1).EQ.'Y'.OR.CANS(1).EQ.'y')
     2     CALL STPL(-1.,-1.)
         ENDIF
        CALL AXIS(AMIN,AMAX,LFLAG,IRES,ABEGC,AENDC,TITLE,CHI,LABEL)
        ISKIP=2/(1000*SF)
        ISKIP=MAX0(1,ISKIP)
        XO=BHORI
        DO 900 I=IBT,IENDC,ISKIP
        XP=BHORI+SF*(I-IBEGC)
        ADAT=AMULT*FR(I)
        IF(LFLAG.EQ.1)ADAT=ALOG(AMAX1(1.,ADAT))
        YDAT=SVERT*(ADAT-AMIN)+BVERT
        IF(I.EQ.IBT)CALL STPL(XO,YDAT)
        IF(ISKIP.GT.1)GOTO 895
        IF(I.GT.IBT)CALL PLOT(XO,YDAT)
        XO=XP+.5*SF
        CALL PLOT(XO,YDAT)
        GOTO 900
895     XDMAX=0
        XDMIN=1000000
        DO 897 J=1,ISKIP
        IARG=I+J-1
      IF(IARG.GT.IENDC)GOTO 899
        COMP=FR(IARG)
        XDMAX=AMAX1(COMP,XDMAX)
897     XDMIN=AMIN1(XDMIN,COMP)
899     ADMIN=AMULT*XDMIN
        ADMAX=AMULT*XDMAX
        IF(LFLAG.EQ.1)ADMIN=ALOG(AMAX1(1.,ADMIN))
        IF(LFLAG.EQ.1)ADMAX=ALOG(AMAX1(1.,ADMAX))
        XDMIN=SVERT*(ADMIN-AMIN)+BVERT
        XDMAX=SVERT*(ADMAX-AMIN)+BVERT
        XO=XP+.5*SF
         CALL PLOT(XO,XDMIN)
        CALL PLOT(XO,XDMAX)
900     CONTINUE
        CALL STPL(0.,0.)
950     CONTINUE
        CTEMP='SEEN ENOUGH? (Y,N,W)\'
        CALL BCHART(0.,.98,CTEMP)
        CALL CHREAD(9,80,RANS,CANS,0,20,IEND)
        IF(CANS(1).EQ.'M')THEN
          CALL STPL(-1.,-1.)
          GOTO 320
        ENDIF
        IFLAG=0
        IF(CANS(1).EQ.'N'.OR.CANS(1).EQ.'n'.OR.CANS(1).EQ.' ')THEN
          CALL STPL(-1.,-1.)
          IENDC1=IMC
          GOTO 53
        ENDIF
        IF(CANS(1).EQ.'Y'.OR.CANS(1).EQ.'y'.OR.CANS(1).EQ.'S'.
     # OR.CANS(1).EQ.'s'.OR.CANS(1).EQ.'E'.OR.CANS(1).EQ.'e'
     # )THEN
        CALL ANSI
        STOP
C M        RETURN
      ENDIF
      IP=1
      IBEGC=RNUMB(CANS,IP,20)
      IENDC=RNUMB(CANS,IP,20)
      IFLAG=0
         IF(FPNAME.EQ.'NULL')GOTO 980
         NA=FPNAME
       STATUS='NEW'
       CALL MAOPEN(1,NA,STATUS)
       II(1)=NA
       WRITE(1,'(A)')II
       WRITE(1,'(A4,'','',I4)')'HDAT',N
       WRITE(1,1923)(INT(FP(J)),J=1,N)
1923   FORMAT(10Z8)
       CLOSE (1)
         NA=FMNAME
       STATUS='NEW'
       CALL MAOPEN(1,NA,STATUS)
       WRITE(1,'(A)')II
       WRITE(1,'(A4,'','',I4)')'HDAT',N
       WRITE(1,1923)(INT(FR(J)),J=1,N)
       CLOSE (1)
980    CONTINUE
        CALL ANSI
        STOP
C M        RETURN
        END
        SUBROUTINE CORREC(F,NT)
        PARAMETER (MAXC=4096)
      CHARACTER*64 NA
      DIMENSION F(MAXC,2),NT(2),IHDAT(10)
      DIMENSION UFILE(2),CFILE(2),FBEGC2(2),FENDC2(2),IBEGC2(2),IENDC2(2
     #)
      CHARACTER*64 UFILE,CFILE,XYFILE,FPNAME,FMNAME,TITLE,STATUS
      COMMON/GLFILE/UFILE,CFILE,XYFILE,FPNAME,FMNAME,TITLE
      COMMON/GLINK/CORR,DIFF,DIFPLT,RAT1,RAT2,FBEGC2,FENDC2,
     #IMIN2,IMAX2,LFLAG2,
     #IBEGC2,IENDC2,
     #IBEGC1,IENDC1,
     #IMIN1,IMAX1,
     #LFLAG1
      COMMON/BATCFL/IBATCH
      DO 10 I=1,2
      IF(NT(I).EQ.0)GOTO 10
C
C *** LINK IN MENU SELECTED IBEG,IEND
C
      IBEG=IBEGC2(I)
      IEND=IENDC2(I)
C**************************************
      IF(IBEG.GT.IEND)GOTO 10
      IBEGM=IBEG-1
      IENDP=IEND+1
C
C *** LINK IN MENU SELECTION
C
      IF(FBEGC2(I).NE.0.)THEN
      PRINT*,' FBEG,FEND',FBEGC2(I),FENDC2(I)
        F(IBEGM,I)=FBEGC2(I)
        F(IENDP,I)=FENDC2(I)
      ENDIF
C***************************
      DF=F(IENDP,I)-F(IBEGM,I)
      DF=DF/(IENDP-IBEGM)
      DO 5 J=IBEG,IEND
      F(J,I)=F(IBEGM,I)+(J-IBEGM)*DF
5     CONTINUE
C
C *** LINK IN MENU SELECTED FILE
C
      NA=CFILE(I)
C*************************
      IF(NA.EQ.'NULL')GOTO 10
C     IF(IBATCH.EQ.0)THEN
        STATUS='NEW'
        CALL MAOPUF(4,NA,STATUS)
C     ENDIF
      XOFF=0.
      WRITE(4)NT(I),XOFF
      WRITE(4)(F(J,I),J=1,NT(I))
C     IF(IBATCH.EQ.0)THEN
        CLOSE(4)
C     ELSE
C       ENDFILE(UNIT=4)
C     ENDIF
10    CONTINUE
      RETURN
      END
C*INCLUDE C:\ROBFIT\FORTRAN\G4LINK
C*NOLIST
C*INCLUDE C:\ROBFIT\FORTRAN\MENURD
C*INCLUDE C:\ROBFIT\FORTRAN\VPLOTS
C*INCLUDE C:\ROBFIT\FORTRAN\NUMOUT
C$LIST
C*INCLUDE C:\ROBFIT\FORTRAN\MAOPEN
C*INCLUDE C:\ROBFIT\FORTRAN\BREAD
C$INCLUDE G4LINK
C$INCLUDE MENURD
C$INCLUDE CMSPLOTS
C$INCLUDE NUMOUT
C$INCLUDE MAOPEN
C$INCLUDE BREAD
