      SUBROUTINE PFIT(N,ILR,F,FB,WX,C,SC,W,IPT,WF,SW,XP,SXP,NPP,
     #  CHIS,IFTC,IWF,JB,NPB,FW,SFW,XOFF,IPW,WPNNT)
      IMPLICIT REAL*8 (A-H,O-Z)
      PARAMETER (MAXGEM=256,MAXFPK=50)
      REAL*4 F,FB,SQRT,WX,XOFF
      COMMON/SCONS/DUM(150),XPS(5),XPL(5),NTYPE,IDUM,XBEG,XEND
      COMMON/FPEAKS/NPF,IPF,XPF(MAXFPK),EPF(MAXFPK),IPTF(MAXFPK)
      DIMENSION F(1),FB(1),WX(1),C(1),SC(1),XP(1),SXP(1),W(1),
     # IPT(1),WF(1),SW(1),ECN(10),EXN(10),EWN(10),
     # CN(10),XN(10),WN(10),IPTN(10),WFN(10),FW(3,5),SFW(5,5)
C *** THIS ROUTINE REFITS THE PEAKS CLOSE TO ILR,  IF NO PEAK IS
C *** CLOSE TO ILR OR IF IFTC=0 A NEW PEAK IS ADDED
C *** IFTC=2 IMPLIES A REFIT, IN WHICH CASE ILR IS THE PEAK BEING
C *** REFITTED
C *** IFTC=-1 IMPLIES A NEGATIVE RESIDUAL IN WHICH CASE NO PEAK IS ADDED
C *** IFTC=3 IMPLIES ADD A PEAK AT THE LARGEST RESIDUAL
C *** IFTC=-3 IMPLIES ADD A NEG PEAK AT THE LARGEST RESIDUAL
C *** FINDING BEGINNING AND ENDING FIT POINTS WHEN REFITTING
        NPB=JB
         XT=ILR+XOFF
         IF(IFTC.LT.0.AND.IWF.NE.-2)THEN
            XTS=XT
            XTL=XT
            DO 100 J=1,NTYPE
            WPG=DSQRT(DMAX1(3D0,FW(1,J)+XT*(FW(2,J)+XT*FW(3,J))))
            XTS=DMIN1(XTS,XT+XPS(J)*WPG)
            XTL=DMAX1(XTL,XT+XPL(J)*WPG)
100         CONTINUE
            GOTO 400
         ENDIF
         IF(IFTC.NE.2)GOTO 200
         INNT=IABS(IPT(ILR))
         XT=XP(ILR)
         XTS=XT+XPS(INNT)*W(ILR)
         XTL=XT+XPL(INNT)*W(ILR)
         GOTO 400

200      CONTINUE

C *** FINDING BEGINNING AND ENDING POINTS WHEN NO PEAK IS AT ILR
C *** WHICH IS NOW THE CHANNEL NUMBER WITH THE LARGEST RESIDUAL

C *** THIS IS WHERE WE FIND THE PEAK TYPE WITH THE MINIMUM INITIAL ERROR
        ERRC=-1.D32
       DO 300 J=1,NTYPE
         XTT=ILR+XOFF
        L=J
        IF(IFTC.LT.0)L=-J
       CT=CQMIN(FB,F,WX,XOFF,N,XTT,WPG,L,FW,SFW,PSBKGE)
        IF(PSBKGE.LT.ERRC)GOTO 300
        CNNT=CT
        ERRC=PSBKGE
        INNT=L
        WPNNT=WPG
         XT=DMAX1(1.D0+XOFF,DMIN1(1.D0*N+XOFF,XTT))
300     CONTINUE
         XTS=XT+WPNNT*XPS(IABS(INNT))
         XTL=XT+WPNNT*XPL(IABS(INNT))

C *** NOW USING XTS AND XTL FIND PEAKS IN THE REGION OF INTEREST

400     CONTINUE
        CALL LOCATE(XTS,XP,NPP,JB)
        JB=JB+1
        CALL LOCATE(XTL,XP,NPP,JE)

C *** INCLUDING ALL POSSIBLE OVERLAPPING PEAKS BEWARE TIME GOES AS NP**3

405     JBM=JB-1
        DO 408 I=1,JBM
        ITYPE=IABS(IPT(I))
        IF(XTS.GT.XP(I)+W(I)*XPS(ITYPE))GOTO 408
        JB=I
        XTS=DMIN1(XTS,XP(I)+W(I)*XPS(ITYPE))
        GOTO 405
408     CONTINUE
415     JEP=JE+1
        DO 418 J=JEP,NPP
        I=NPP+JEP-J
        ITYPE=IABS(IPT(I))
        IF(XTL.LT.XP(I)+W(I)*XPS(ITYPE))GOTO 418
        JE=I
        XTL=DMAX1(XTL,XP(I)+W(I)*XPL(ITYPE))
        GOTO 415
418     CONTINUE

C *** CUTTING THE FITTED NUMBER OF PEAKS TO 10

420     IF(JE-JB+1.LT.10)GOTO 500
         IF(JE-JB+1.EQ.10.AND.IABS(IFTC).NE.3)GOTO 500
         ITY1=IABS(IPT(JE))
         ITY2=IABS(IPT(JB))
         IF(ITY1.LE.0.OR.ITY1.GT.5)PRINT*,' ARRAY PROB ITY1=',ITY1
         IF(ITY2.LE.0.OR.ITY2.GT.5)THEN
            PRINT*,' ARRAY PROB ITY2=',ITY2
            PRINT*,' JB,JE',JB,JE
         ENDIF
         IF((XT-XP(JE))/XPS(ITY1).LT.(XT-XP(JB))/XPL(ITY2))GOTO 450
         IF(XP(JE-1).LT.XT)GOTO 450
425      JE=JE-1
         GOTO 420

450      CONTINUE
         IF(XP(JB+1).GT.XT)GOTO 425
         JB=JB+1
         GOTO 420

C *** NOW THAT WE HAVE FOUND JB AND JE WE NEED TO RESTABLISH XTS AND XTL
C *** AND ADD THE OLD PEAKS TO THE STARTING GUESSES FOR THE NEW

500     CONTINUE
         IM=1
         IF(JB.GT.JE)GOTO 610
         IF(IABS(IFTC).NE.3)THEN
            XTS=1.D32
            XTL=-XTS
         ENDIF
        DO 600 I=JB,JE
        ECN(IM)=SC(I)
        EXN(IM)=SXP(I)
        EWN(IM)=SW(I)
        CN(IM)=C(I)
        XN(IM)=XP(I)
        WN(IM)=W(I)
        IPTN(IM)=IPT(I)
         ITYPE=IABS(IPT(I))
        XTS=DMIN1(XTS,XN(IM)+XPS(ITYPE)*WN(IM))
        XTL=DMAX1(XTL,XN(IM)+XPL(ITYPE)*WN(IM))
        IM=IM+1
600     CONTINUE

C *** REMOVE THE NEW PEAKS FROM THE FILE LIST

610      IM=IM-1
         IF(IFTC.LT.0.AND.IM.EQ.0.AND.IWF.NE.-2)RETURN
         IF(IM.EQ.0)GOTO 650
        NPP=NPP-IM
        DO 620 I=JB,NPP
        SC(I)=SC(I+IM)
        SXP(I)=SXP(I+IM)
        SW(I)=SW(I+IM)
        C(I)=C(I+IM)
        XP(I)=XP(I+IM)
        W(I)=W(I+IM)
620      IPT(I)=IPT(I+IM)

C *** UPDATING CHIS AND THE FILE FOR THE REMOVAL OF THESE TERMS
650     CONTINUE
        IB=XTS-.2*(XTL-XTS)-XOFF
        IE=XTL+.2*(XTL-XTS)-XOFF
        IB=MAX0(1,IB)
        IE=MIN0(N,IE)
      DO 700 I=IB,IE
700   CHIS=CHIS-(F(I)-FB(I))**2*WX(I)
       DO 750 I=IB,IE
      XI=I+XOFF
750   FB(I)=FB(I)-POLYA(XI,CN,XN,WN,IPTN,IM)

C *** GETTING READY TO CALL QMIN

         IF(IABS(IFTC).EQ.3.OR.(IABS(IFTC).EQ.1.AND.IM.EQ.0))THEN
            IM=IM+1
            CN(IM)=CNNT
            WN(IM)=WPNNT
            IPTN(IM)=INNT
            XN(IM)=XT
        ENDIF
        IQFL=0
        IBO=IB
        IEO=IE
5173    CONTINUE
        IF(IABS(IWF).NE.9)THEN
C *** CHECKING FOR FPEAKS
        IF(NPF.EQ.0)GOTO 5174
        XBEGF=IB+XOFF
        XENDF=IE+XOFF
        IPF=0
        DO 760 I=1,NPF
        XFL=XPF(I)-2*EPF(I)
        IF(XFL.GT.XENDF)GOTO 760
        XFU=XPF(I)+2*EPF(I)
        IF(XFU.LT.XBEGF)GOTO 760
        IPF=1
        GOTO 5174
760     CONTINUE
5174    CALL QMIN(FB,F,WX,IB,IE,IM,CN,XN,WN,IPTN,WFN,
     # FW,SFW,XOFF,IPW,ECN,EXN,EWN)
        ENDIF
        IF(IWF.EQ.9)
     # CALL FQMIN(FB,F,WX,IB,IE,IM,CN,XN,WN,IPTN,WFN,
     # XOFF,IPW,ECN,EXN,EWN)
        IF(IWF.EQ.-9)THEN
          CALL FNMIN(FB,F,WX,IB,IE,IM,CN,XN,WN,IPTN,WFN,
     #     XOFF,IPW,ECN,EXN,EWN)
        ENDIF
C *** CHECKING TO SEE THAT WE ARE IN THE CORRECT RANGE
        IF(IQFL.EQ.1)GOTO 5184
        DO 5180 I=1,IM
        IPTT=XN(I)-XOFF-2*WN(I)
        IPTT=MAX0(1,IPTT)
        IF(IPTT.GE.IB)GOTO 5175
        IPC=XN(I)-XOFF+WN(I)
        IF(IPC.LT.IB)CN(I)=.1*SQRT(ABS(WX(IPTT)))
        IF(IPC.LT.IB)GOTO 5175
        IQFL=1
        IB=IPTT
5175    IPTT=XN(I)-XOFF+WN(I)
        IPTT=MIN0(IPTT,N)
        IF(IPTT.LE.IE)GOTO 5180
        IPC=XN(I)-XOFF-WN(I)
        IF(IPC.GT.IE)CN(I)=.1*SQRT(ABS(WX(IPTT)))
        IF(IPC.GT.IE)GOTO 5180
        IE=IPTT
        IQFL=1
5180    CONTINUE
        IF(IQFL.NE.1)GOTO 5184
        IF(IB.GE.IBO)GOTO 5182
        IBOM=IBO-1
        DO 5181 I=IB,IBOM
5181    CHIS=CHIS-(F(I)-FB(I))**2*WX(I)
5182    IF(IE.LE.IEO)GOTO 5173
        IEOP=IEO+1
        DO 5183 I=IEOP,IE
5183    CHIS=CHIS-(F(I)-FB(I))**2*WX(I)
        GOTO 5173
5184    CONTINUE
        IF(IM.EQ.0)GOTO 541
C *** ADJUSTING THE BEGINING AND ENDING POINTS FOR THE NEW PEAKS
        DO 5190 I=1,IM
        ITEST=IABS(IPTN(I))
        XBEG=DMIN1(XBEG,WN(I)*XPS(ITEST))
5190    XEND=DMAX1(XEND,WN(I)*XPL(ITEST))
C FROM HERE TO 540 XN IS BEING INSERTED INTO XP IN SUCH A WAY AS TO KEEP
C IN ASCENDING ORDER
      DO 540 I=1,IM
       CN(I)=DABS(CN(I))
        JPT=XN(I)-XOFF
        WN(I)=DMAX1(1.5D0,WN(I))
        JPT=MAX0(1,MIN0(N,JPT))
        IF(XN(I).LT.0..OR.XN(I).GT.N+XOFF)CN(I)=0.D0
        IF(IABS(IWF).EQ.9)GOTO 519
        IF(CN(I)*CN(I).LT.1./DSQRT(DABS(WX(JPT)*WN(I))))CN(I)=0.D0
        IF(CN(I).LT.1.D-12)GOTO 540
519   IF(NPP.LT.1)GOTO 532
520   CALL LOCATE(XN(I),XP,NPP,J)
      IF(J.EQ.NPP)GOTO 535
      JU=NPP+1
      JL=NPP
530   XP(JU)=XP(JL)
        WF(JU)=WF(JL)
      W(JU)=W(JL)
        IPT(JU)=IPT(JL)
      C(JU)=C(JL)
        SXP(JU)=SXP(JL)
        SW(JU)=SW(JL)
        SC(JU)=SC(JL)
      JU=JU-1
      JL=JL-1
      IF(JL-J)535,535,530
532   J=0
535   JP=J+1
        NPB=JP
        SC(JP)=ECN(I)
        SW(JP)=EWN(I)
        SXP(JP)=EXN(I)
      XP(JP)=XN(I)
        WF(JP)=WFN(I)
        IPT(JP)=IPTN(I)
      W(JP)=WN(I)
      C(JP)=CN(I)
      NPP=NPP+1
540   CONTINUE
541   CONTINUE
C CORRECTING THE FB AND RESIDUALS FOR THE NEW PEAK
      IF(NPP.EQ.0) RETURN
      DO 543 I=IB,IE
      XI=I+XOFF
      FB(I)=POLYA(XI,C,XP,W,IPT,NPP)
543   CHIS=CHIS+(F(I)-FB(I))**2*WX(I)
      RETURN
      END
